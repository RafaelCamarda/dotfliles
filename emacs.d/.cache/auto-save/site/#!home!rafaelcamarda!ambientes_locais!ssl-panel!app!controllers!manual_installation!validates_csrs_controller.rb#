module ManualInstallation
  class ValidatesCsrsController < ApplicationController
    def create
      email_workflow = CertificateIssue::EmailValidationWorkflow.new
      @certificate = email_workflow.obtain_domain_approvers(
        certificate_params[:csr]
      )
      fetch_customer

      if @certificate.success
        render partial: 'certificates/form',
               locals: { approver_emails: @certificate.emails_available }
      else
        render json: { message: @certificate.error_message },
               status: :unprocessable_entity
      end
    end

    private

    def certificate_params
      params.require(:certificate).permit(:csr)
    end
  end
end
